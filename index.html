<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Weighted Grade Planner</title>
<style>
  :root{
    --bg:#0b0b10;--panel:#111219;--panel2:#0f1016;--text:#e8ebf2;--muted:#a8afbd;--line:#242739;
    --brand:#6d7cff;--ok:#22c55e;--warn:#f59e0b;--err:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:500 15px/1.55 system-ui,Segoe UI,Inter,Arial,sans-serif}
  .container{max-width:1100px;margin:40px auto;padding:0 16px}
  h1{margin:0 0 6px;font-weight:800}
  p.muted{margin:.25rem 0 1rem;color:var(--muted)}
  .panel{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--line);border-radius:14px;padding:16px;margin:14px 0}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  label{font-weight:600}
  input,button{border-radius:10px;border:1px solid #2a2f46;background:#121423;color:var(--text);padding:10px 12px}
  input[type="number"]{text-align:right}
  .btn{cursor:pointer}
  .btn:hover{border-color:#3b4161;transform:translateY(-1px)}
  .primary{background:linear-gradient(135deg,var(--brand),#9b6dff);border-color:transparent}
  .danger{border-color:#5b1f26;background:#251015}
  table{width:100%;border-collapse:collapse;border-spacing:0}
  th,td{border-top:1px solid var(--line);padding:10px 8px;text-align:left}
  th{font-weight:700;color:#cfd3e6;background:#121425;position:sticky;top:0;z-index:1}
  tbody tr:first-child td{border-top:1px solid var(--line)}
  .right{text-align:right}
  .mutedSmall{color:var(--muted);font-size:12px}
  .badge{display:inline-block;padding:4px 8px;border:1px solid #353a56;border-radius:999px;background:#121423;color:#cfd3ff;font-size:12px}
  .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
</style>
</head>
<body>
<div class="container">
  <h1>Weighted Grade Planner</h1>
  <p class="muted">Enter category <b>weights</b>, your current <b>earned/possible</b>, and the <b>planned total</b> points for each category.
    Set a target final grade to see the <b>required average on remaining work</b>. Add/remove rows as needed.</p>

  <!-- Controls -->
  <div class="panel">
    <div class="row">
      <button class="btn" id="addRow">+ Add Category</button>
      <button class="btn" id="resetMarks">Reset marks & weights</button>
      <button class="btn danger" id="clearAll">Clear ALL</button>
      <button class="btn" id="exportBtn">Export JSON</button>
      <label class="btn" for="importFile" style="cursor:pointer">Import JSON</label>
      <input id="importFile" type="file" accept="application/json" style="display:none">
    </div>
    <div class="row" style="margin-top:10px">
      <label for="target">Target final grade:</label>
      <input id="target" type="number" min="0" max="100" step="0.1" value="90" style="width:120px"> %
      <label for="futureAssume" style="margin-left:18px">Assumed future % (default):</label>
      <input id="futureAssume" type="number" min="0" max="100" step="0.1" value="85" style="width:120px"> %
      <div class="mutedSmall">You can override per-category later.</div>
    </div>
  </div>

  <!-- Table -->
  <div class="panel" style="overflow:auto;max-height:70vh">
    <table id="gradeTable" aria-label="grade table">
      <thead>
        <tr>
          <th>Category</th>
          <th class="right">Weight</th>
          <th class="right">Earned</th>
          <th class="right">Possible (to date)</th>
          <th class="right">Planned Total</th>
          <th class="right">% so far</th>
          <th class="right">Future % (optional)</th>
          <th class="right">Projected Category %</th>
          <th class="right">Weighted Contribution</th>
          <th></th>
        </tr>
      </thead>
      <tbody id="rows"></tbody>
      <tfoot>
        <tr>
          <td class="right" colspan="1">Totals:</td>
          <td class="right" id="weightSum">0%</td>
          <td class="right" id="earnedSum">0</td>
          <td class="right" id="possibleSum">0</td>
          <td class="right" id="plannedSum">0</td>
          <td class="right" id="avgSoFar">—</td>
          <td class="right">—</td>
          <td class="right" id="projAvg">—</td>
          <td class="right" id="weightedTotal">0%</td>
          <td></td>
        </tr>
      </tfoot>
    </table>
  </div>

  <!-- Status / Outputs -->
  <div class="panel">
    <div id="status" class="muted">Weights should sum to <b>100%</b>.</div>
    <div class="row" style="justify-content:space-between;margin-top:10px">
      <div>
        <div><b>Projected Final (assumed future %):</b> <span id="overall" class="ok">0.00%</span></div>
        <div class="mutedSmall">
          Range if you score 100% on everything remaining: <span id="rangeMax">—</span> ·
          if 0% on remaining: <span id="rangeMin">—</span>
        </div>
      </div>
      <div>
        <b>To hit target <span id="targetEcho">90%</span> you need average on remaining: </b>
        <span id="needed" class="badge">—</span>
      </div>
    </div>
    <div class="row" style="margin-top:12px">
      <label for="whatIf">What-if future %:</label>
      <input id="whatIf" type="range" min="0" max="100" step="1" value="85" style="width:260px">
      <span id="whatIfEcho" class="badge">85%</span>
      <span class="mutedSmall">Drag to see how your final grade changes.</span>
      <div style="margin-left:auto">
        <b>Projected with what-if:</b> <span id="whatIfResult" class="ok">—</span>
      </div>
    </div>
    <div id="bandWarn" class="mutedSmall" style="margin-top:8px"></div>
  </div>

  <div class="panel">
    <b>Notes / Requirements</b>
    <ul class="mutedSmall">
      <li>Enter weights as <i>20</i> or <i>20%</i>. Weights should total 100% for accurate projections.</li>
      <li><b>Planned Total</b> = total points expected in the category by term end. Leave blank if no more items remain.</li>
      <li>“Required average on remaining” uses: <code>needed = (Target − current_weighted) / weighted_remaining</code>.</li>
      <li>Use the “What-if” slider to see how your grade could rise or fall depending on future scores.</li>
    </ul>
  </div>
</div>

<script>
  // ---------- utils ----------
  const $ = (s, d=document)=>d.querySelector(s);
  const $$ = (s, d=document)=>Array.from(d.querySelectorAll(s));
  const pct = v => isFinite(v) ? (v*100).toFixed(2)+'%' : '—';
  const toNum = v => { const s=String(v??'').trim(); if(!s) return NaN; return parseFloat(s); };
  const parseWeight = raw => { const s=String(raw??'').trim(); if(!s) return 0; return s.endsWith('%')? parseFloat(s)/100 : parseFloat(s)/100; };

  function rowTemplate(d={}) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input placeholder="Assignments / Exams / Project" value="${d.name||''}"></td>
      <td class="right"><input inputmode="decimal" placeholder="20 or 20%" value="${d.weight||''}"></td>
      <td class="right"><input inputmode="decimal" placeholder="earned" value="${d.earned||''}"></td>
      <td class="right"><input inputmode="decimal" placeholder="possible so far" value="${d.possible||''}"></td>
      <td class="right"><input inputmode="decimal" placeholder="planned total" value="${d.planned||''}"></td>
      <td class="right"><span class="sofar">—</span></td>
      <td class="right"><input inputmode="decimal" placeholder="override %" value="${d.future||''}"></td>
      <td class="right"><span class="projCat">—</span></td>
      <td class="right"><span class="weighted">—</span></td>
      <td><button class="btn danger del">Delete</button></td>`;
    tr.querySelectorAll('input').forEach(i=>i.addEventListener('input', recalc));
    tr.querySelector('.del').addEventListener('click', ()=>{ tr.remove(); recalc(); });
    return tr;
  }

  function getRowsData(){
    return $$('#rows tr').map(tr=>{
      const [name, wt, e, p, plan, , fut] = tr.querySelectorAll('input');
      return {
        name: name.value,
        weightRaw: wt.value,
        weight: parseWeight(wt.value),
        earned: toNum(e.value),
        possible: toNum(p.value),
        planned: toNum(plan.value),
        future: toNum(fut.value)
      };
    });
  }

  function setRowsData(arr){
    $('#rows').innerHTML = '';
    arr.forEach(d=>$('#rows').appendChild(rowTemplate(d)));
    recalc();
  }

  function calcProjection(rows, defaultFuturePct){
    let weightSum=0, earnedSum=0, possibleSum=0, plannedSum=0;
    let weightedCurrent=0, weightedRemaining=0, projectedWeighted=0;
    rows.forEach((r, idx)=>{
      const w = isFinite(r.weight)? r.weight : 0;
      const e = isFinite(r.earned)? r.earned : 0;
      const p = isFinite(r.possible)? r.possible : 0;
      const t = isFinite(r.planned)? (r.planned>0?r.planned:NaN) : NaN; // planned total
      const plan = isFinite(t) ? t : (isFinite(p) ? p : 0);
      const remainingPts = Math.max(plan - (isFinite(p)?p:0), 0);
      const sofarPct = (p>0) ? (e/p) : NaN;
      const futPct = isFinite(r.future) ? (r.future/100) : (isFinite(defaultFuturePct)? defaultFuturePct/100 : 0);
      const projPct = plan>0 ? ((e + futPct*remainingPts)/plan) : (isFinite(sofarPct)? sofarPct : 0);

      const currentWeightedPart = plan>0 && p>0 ? w * (e/plan) : 0;
      const remainingWeightedPart = plan>0 ? w * (remainingPts/plan) : 0;
      const weightedCat = w * projPct;

      weightSum += w;
      if (p>0){ earnedSum += e; possibleSum += p; }
      plannedSum += plan;
      weightedCurrent += currentWeightedPart;
      weightedRemaining += remainingWeightedPart;
      projectedWeighted += weightedCat;

      const tr = $$('#rows tr')[idx];
      tr.querySelector('.sofar').textContent = isFinite(sofarPct)? pct(sofarPct) : '—';
      tr.querySelector('.projCat').textContent = pct(projPct);
      tr.querySelector('.weighted').textContent = pct(weightedCat);
    });

    return {
      weightSum, earnedSum, possibleSum, plannedSum,
      weightedCurrent, weightedRemaining, projectedWeighted
    };
  }

  function recalc(){
    const target = toNum($('#target').value);
    const defaultFuture = toNum($('#futureAssume').value);
    const rows = getRowsData();
    const s = calcProjection(rows, defaultFuture);

    $('#weightSum').textContent = (s.weightSum*100).toFixed(2)+'%';
    $('#earnedSum').textContent = isFinite(s.earnedSum)? s.earnedSum.toFixed(2) : '0';
    $('#possibleSum').textContent = isFinite(s.possibleSum)? s.possibleSum.toFixed(2) : '0';
    $('#plannedSum').textContent = isFinite(s.plannedSum)? s.plannedSum.toFixed(2) : '0';
    $('#avgSoFar').textContent = (s.possibleSum>0) ? pct(s.earnedSum/s.possibleSum) : '—';
    $('#projAvg').textContent = pct(s.projectedWeighted / (s.weightSum||1));
    $('#weightedTotal').textContent = pct(s.projectedWeighted);

    $('#overall').textContent = pct(s.projectedWeighted);
    $('#targetEcho').textContent = isFinite(target)? target.toFixed(1)+'%' : '—';

    const diff = s.weightSum - 1;
    const status = $('#status');
    status.innerHTML = Math.abs(diff) < 1e-6
      ? 'Weights sum to <b>100%</b>.'
      : `Weights are <span class="${diff>0?'err':'warn'}">${Math.abs(diff*100).toFixed(2)}% ${diff>0?'over':'under'}</span> 100%. Adjust to total 100%.`;

    let needed = NaN;
    if (isFinite(target)){
      const T = target/100;
      if (s.weightedRemaining > 0){
        needed = (T - s.weightedCurrent) / s.weightedRemaining;
        const txt = (needed>=0 && needed<=1) ? (needed*100).toFixed(2)+'%' :
          (needed>1 ? 'Impossible (>100% needed)' :
           (needed<0 ? 'Already guaranteed (≤0% needed)' : '—'));
        $('#needed').textContent = txt;
        $('#needed').className = 'badge ' + (needed>1 ? 'err' : (needed<0 ? 'ok' : ''));
      } else {
        $('#needed').textContent = 'No remaining weight';
        $('#needed').className = 'badge warn';
      }
    } else {
      $('#needed').textContent = '—';
      $('#needed').className = 'badge';
    }

    const maxFinal = s.weightedCurrent + 1*s.weightedRemaining;
    const minFinal = s.weightedCurrent + 0*s.weightedRemaining;
    $('#rangeMax').textContent = pct(maxFinal);
    $('#rangeMin').textContent = pct(minFinal);

    const wif = toNum($('#whatIf').value);
    $('#whatIfEcho').textContent = (wif||0).toFixed(0)+'%';
    const alt = calcProjection(rows, wif);
    $('#whatIfResult').textContent = pct(alt.projectedWeighted);
    $('#whatIfResult').className = (alt.projectedWeighted>=0.9)?'ok':(alt.projectedWeighted>=0.8?'warn':'err');

    const band = alt.projectedWeighted>=0.9?'A (≥90%)'
                : alt.projectedWeighted>=0.8?'B (80–89%)'
                : alt.projectedWeighted>=0.7?'C (70–79%)'
                : 'below C';
    $('#bandWarn').innerHTML = `At ${wif.toFixed(0)}% on remaining work, you’re tracking a <b>${band}</b>.`;

    localStorage.setItem('grade_planner_v2', JSON.stringify(getRowsData()));
  }

  // --- NEW: Reset marks & weights (keep rows & category names) ---
  function resetMarksAndWeights(){
    $$('#rows tr').forEach(tr=>{
      const inputs = tr.querySelectorAll('input');
      const [nameI, wtI, eI, pI, planI, futI] = inputs;
      // keep name; clear weight and numeric fields
      if (wtI) wtI.value = '';
      if (eI) eI.value = '';
      if (pI) pI.value = '';
      if (planI) planI.value = '';
      if (futI) futI.value = '';
    });
    // optional: keep target and what-if as is; just recalc
    recalc();
    // persist cleared state (names preserved)
    localStorage.setItem('grade_planner_v2', JSON.stringify(getRowsData()));
  }

  // export / import
  $('#exportBtn').addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(getRowsData(), null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'grade_setup.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });
  $('#importFile').addEventListener('change', e=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = ()=>{ try{ setRowsData(JSON.parse(reader.result)); }catch{ alert('Invalid JSON'); } e.target.value=''; };
    reader.readAsText(f);
  });

  // buttons
  $('#addRow').addEventListener('click', ()=>{ $('#rows').appendChild(rowTemplate()); recalc(); });
  $('#resetMarks').addEventListener('click', resetMarksAndWeights);
  $('#clearAll').addEventListener('click', ()=>{ if(confirm('Clear ALL rows and data?')){ setRowsData([]); } });

  // init
  (function init(){
    const saved = localStorage.getItem('grade_planner_v2');
    if(saved){ try{ setRowsData(JSON.parse(saved)); return; }catch{} }
    setRowsData([
      {name:'Assignments', weight:'20', earned:'', possible:'', planned:'', future:''},
      {name:'Project', weight:'30', earned:'', possible:'', planned:'', future:''},
      {name:'Quizzes/Exams', weight:'40', earned:'', possible:'', planned:'', future:''},
      {name:'Participation', weight:'10', earned:'', possible:'', planned:'', future:''},
    ]);
  })();

  $('#target').addEventListener('input', recalc);
  $('#futureAssume').addEventListener('input', recalc);
  $('#whatIf').addEventListener('input', recalc);
</script>
</body>
</html>
